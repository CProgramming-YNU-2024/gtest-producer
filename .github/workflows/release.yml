name: "Publish App Artifact"

on:
  push:
    branches:
      - main

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    # Grant permissions for the GITHUB_TOKEN to push to GHCR
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create a sample application archive
        run: |
          mkdir -p my-app
          echo "This is the content of my application v1.0" > my-app/content.txt
          echo "Release notes for ${{ github.sha }}" > my-app/release.md
          tar -czvf my-app-bundle.tar.gz my-app
          echo "Created my-app-bundle.tar.gz"

      - name: Install ORAS CLI
        uses: oras-project/setup-oras@v1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push artifact to GHCR using ORAS
        run: |
          # Use the git commit SHA as a unique and traceable tag
          oras push ghcr.io/${{ github.repository }}/my-app-bundle:${{ github.sha }} my-app-bundle.tar.gz
