name: Build and Release GTest, Uchardet, and Libvterm Artifacts

on:
  push:
    branches:
      - main

jobs:
  build-libs:
    runs-on: ubuntu-latest
    # Grant permissions for the GITHUB_TOKEN to create releases
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build GTest
        run: |
          git clone --depth 1 --branch v1.14.0 https://github.com/google/googletest.git
          cd googletest
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j$(nproc)

      - name: Package artifacts
        run: |
          mkdir -p gtest-libs
          cp googletest/build/lib/*.a gtest-libs/
          cp -r googletest/googletest/include gtest-libs/

          # Create a CMake config file for easier find_package usage
          mkdir -p gtest-libs/lib/cmake/GTest
          cat > gtest-libs/lib/cmake/GTest/GTestConfig.cmake << 'EOF'
          # GTest CMake configuration file
          get_filename_component(GTEST_CMAKE_DIR "${CMAKE_CURRENT_LIST_FILE}" PATH)
          get_filename_component(GTEST_ROOT "${GTEST_CMAKE_DIR}/../../.." ABSOLUTE)

          set(GTEST_INCLUDE_DIRS "${GTEST_ROOT}/include")
          set(GTEST_LIBRARIES "${GTEST_ROOT}/libgtest.a")
          set(GTEST_MAIN_LIBRARIES "${GTEST_ROOT}/libgtest_main.a")
          set(GTEST_BOTH_LIBRARIES ${GTEST_LIBRARIES} ${GTEST_MAIN_LIBRARIES})

          if(NOT TARGET GTest::gtest)
            add_library(GTest::gtest STATIC IMPORTED)
            set_target_properties(GTest::gtest PROPERTIES
              IMPORTED_LOCATION "${GTEST_LIBRARIES}"
              INTERFACE_INCLUDE_DIRECTORIES "${GTEST_INCLUDE_DIRS}"
              INTERFACE_LINK_LIBRARIES "pthread"
            )
          endif()

          if(NOT TARGET GTest::gtest_main)
            add_library(GTest::gtest_main STATIC IMPORTED)
            set_target_properties(GTest::gtest_main PROPERTIES
              IMPORTED_LOCATION "${GTEST_MAIN_LIBRARIES}"
              INTERFACE_INCLUDE_DIRECTORIES "${GTEST_INCLUDE_DIRS}"
              INTERFACE_LINK_LIBRARIES "GTest::gtest;pthread"
            )
          endif()

          set(GTest_FOUND TRUE)
          set(GTEST_FOUND TRUE)
          EOF

          tar czf gtest.tar.gz gtest-libs/

      - name: Build Uchardet
        run: |
          git clone --depth 1 --branch v0.0.8 https://gitlab.freedesktop.org/uchardet/uchardet.git
          cd uchardet
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_BINARY=OFF -DBUILD_SHARED_LIBS=OFF
          cmake --build build -j$(nproc)

      - name: Package Uchardet artifacts
        run: |
          mkdir -p uchardet-libs
          cp uchardet/build/src/libuchardet.a uchardet-libs/
          cp -r uchardet/src/*.h uchardet-libs/

          # Create a CMake config file for easier find_package usage
          mkdir -p uchardet-libs/lib/cmake/Uchardet
          cat > uchardet-libs/lib/cmake/Uchardet/UchardetConfig.cmake << 'EOF'
          # Uchardet CMake configuration file
          get_filename_component(UCHARDET_CMAKE_DIR "${CMAKE_CURRENT_LIST_FILE}" PATH)
          get_filename_component(UCHARDET_ROOT "${UCHARDET_CMAKE_DIR}/../../.." ABSOLUTE)

          set(UCHARDET_INCLUDE_DIRS "${UCHARDET_ROOT}")
          set(UCHARDET_LIBRARIES "${UCHARDET_ROOT}/libuchardet.a")

          if(NOT TARGET Uchardet::Uchardet)
            add_library(Uchardet::Uchardet STATIC IMPORTED)
            set_target_properties(Uchardet::Uchardet PROPERTIES
              IMPORTED_LOCATION "${UCHARDET_LIBRARIES}"
              INTERFACE_INCLUDE_DIRECTORIES "${UCHARDET_INCLUDE_DIRS}"
            )
          endif()

          set(Uchardet_FOUND TRUE)
          set(UCHARDET_FOUND TRUE)
          EOF

          tar czf uchardet.tar.gz uchardet-libs/

      - name: Build libvterm
        run: |
          # Install libtool-bin (provides the 'libtool' command required by libvterm's Makefile)
          sudo apt-get update && sudo apt-get install -y libtool-bin

          git clone --depth 1 https://github.com/neovim/libvterm.git
          cd libvterm

          # Build libvterm using make
          make

      - name: Package libvterm artifacts
        run: |
          mkdir -p libvterm-libs/include

          # Copy static library (extract from .libs created by libtool)
          cp libvterm/.libs/libvterm.a libvterm-libs/

          # Copy headers
          cp libvterm/include/*.h libvterm-libs/include/

          # Create a CMake config file for easier find_package usage
          mkdir -p libvterm-libs/lib/cmake/Libvterm
          cat > libvterm-libs/lib/cmake/Libvterm/LibvtermConfig.cmake << 'EOF'
          # Libvterm CMake configuration file
          get_filename_component(LIBVTERM_CMAKE_DIR "${CMAKE_CURRENT_LIST_FILE}" PATH)
          get_filename_component(LIBVTERM_ROOT "${LIBVTERM_CMAKE_DIR}/../../.." ABSOLUTE)

          set(LIBVTERM_INCLUDE_DIRS "${LIBVTERM_ROOT}/include")
          set(LIBVTERM_LIBRARIES "${LIBVTERM_ROOT}/libvterm.a")

          if(NOT TARGET Libvterm::Libvterm)
            add_library(Libvterm::Libvterm STATIC IMPORTED)
            set_target_properties(Libvterm::Libvterm PROPERTIES
              IMPORTED_LOCATION "${LIBVTERM_LIBRARIES}"
              INTERFACE_INCLUDE_DIRECTORIES "${LIBVTERM_INCLUDE_DIRS}"
            )
          endif()

          set(Libvterm_FOUND TRUE)
          set(LIBVTERM_FOUND TRUE)
          EOF

          tar czf libvterm.tar.gz libvterm-libs/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libs
          path: |
            gtest.tar.gz
            uchardet.tar.gz
            libvterm.tar.gz

  build-pty-runner:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: pty_runner
            asset_name: pty_runner-linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: pty_runner.exe
            asset_name: pty_runner-windows-x64.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: pty_runner
            asset_name: pty_runner-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: pty_runner
            asset_name: pty_runner-macos-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build PTY Runner
        run: |
          cd pty_runner
          cargo build --release --target ${{ matrix.target }}

      - name: Upload PTY Runner artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: pty_runner/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

  create-release:
    needs: [build-libs, build-pty-runner]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Prepare PTY Runner binaries
        run: |
          # Move binaries out of their artifact directories and rename
          cp pty_runner-linux-x64/pty_runner ./pty_runner-linux-x64
          cp pty_runner-windows-x64.exe/pty_runner.exe ./pty_runner-windows-x64.exe
          cp pty_runner-macos-x64/pty_runner ./pty_runner-macos-x64
          cp pty_runner-macos-arm64/pty_runner ./pty_runner-macos-arm64

      - name: Create Version Tag and Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create a unique tag name, e.g., "build-20251008.1"
          TAG_NAME="build-$(date +%Y%m%d).${{ github.run_number }}"

          # Create the release and upload the artifacts in one command using the GitHub CLI
          gh release create "$TAG_NAME" \
             --notes "Automated build artifact" \
             libs/gtest.tar.gz \
             libs/uchardet.tar.gz \
             libs/libvterm.tar.gz \
             pty_runner-linux-x64 \
             pty_runner-windows-x64.exe \
             pty_runner-macos-x64 \
             pty_runner-macos-arm64
