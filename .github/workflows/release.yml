name: Build and Publish GTest
on:
  push:
    tags: ["v*"]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Build GTest
        run: |
          git clone --depth 1 --branch v1.14.0 https://github.com/google/googletest.git
          cd googletest
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j$(nproc)

      - name: Package artifacts
        run: |
          mkdir -p gtest-libs
          cp googletest/build/lib/*.a gtest-libs/
          cp -r googletest/googletest/include gtest-libs/
          tar czf gtest-prebuilt.tar.gz gtest-libs/

      - name: Upload to GitHub Packages
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          curl -X PUT \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/gzip" \
            --data-binary @gtest-prebuilt.tar.gz \
            "https://maven.pkg.github.com/CProgramming-YNU-2024/gtest-producer/gtest-prebuilt/${VERSION}/gtest-prebuilt-${VERSION}.tar.gz"
